<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Your Cart</title>

<link href="https://fonts.googleapis.com/css2?family=Didot&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body {
  background:#4b0e1f;
  color:#fff;
  font-family:'Poppins',sans-serif;
  padding:20px;
  direction: ltr;
}

h1 {
  text-align:center;
  margin-bottom:30px;
  text-shadow:0 0 10px rgba(255,200,210,0.5);
  font-family: 'Didot', serif;
}

/* LANG */
#langSelectContainer { text-align:center; margin-bottom:20px; }
#langSelect {
  padding:6px 10px;
  border-radius:8px;
  border:none;
  font-weight:bold;
  color:#4b0e1f;
  background:#ffb3c6;
  cursor:pointer;
  font-family: 'Poppins', sans-serif;
}

/* CART ITEM */
.cart-item {
  background:#3b0a1a;
  padding:15px;
  border-radius:12px;
  margin-bottom:15px;
  display:flex;
  gap:15px;
  align-items:center;
  flex-wrap: wrap;
}
.cart-item img {
  width:100px;
  height:100px;
  object-fit:cover;
  border-radius:12px;
  flex-shrink: 0;
  transition: all 0.3s ease;
}
.item-info { flex:1; }
.item-info h3 {
  margin:0;
  font-family: 'Didot', serif;
  font-size:18px;
  color:#ffb3c6;
}
.price {
  font-size:18px;
  font-weight:bold;
  margin:5px 0;
  font-family: 'Poppins', sans-serif;
}
.qty-box {
  display:flex;
  align-items:center;
  gap:10px;
  margin-top:10px;
}
.qty-box button {
  background:#ffb3c6;
  color:#4b0e1f;
  border:none;
  padding:5px 10px;
  font-weight:bold;
  border-radius:8px;
  cursor:pointer;
  font-family: 'Poppins', sans-serif;
}
.remove-btn {
  background:#ff5f5f;
  color:#fff;
  border:none;
  padding:8px 12px;
  border-radius:10px;
  cursor:pointer;
  font-weight:bold;
  font-family: 'Poppins', sans-serif;
}

/* TOTAL */
.total-box {
  background:#3b0a1a;
  padding:20px;
  border-radius:15px;
  text-align:center;
  margin-top:30px;
  font-size:22px;
  font-weight:bold;
  font-family: 'Poppins', sans-serif;
}

/* CHECKOUT BUTTON */
#checkoutBtn {
  display:block;
  text-align:center;
  background:#ffb3c6;
  color:#4b0e1f;
  margin-top:20px;
  padding:15px;
  border-radius:12px;
  font-weight:700;
  font-size:20px;
  text-decoration:none;
  font-family:'Poppins',sans-serif;
  box-shadow:0 0 12px rgba(255,179,198,0.4);
  transition:0.25s;
}
#checkoutBtn:hover { background:#ffc2d2; transform:scale(1.03); }

/* BACK */
.back-link {
  display:block;
  text-align:center;
  color:#ffb3c6;
  margin-top:35px;
  font-size:18px;
  font-family: 'Poppins', sans-serif;
}

/* RESPONSIVE */
@media(max-width:1024px){
  .cart-item img { width:80px; height:80px; }
}
@media(max-width:768px){
  .cart-item { flex-direction: column; align-items: flex-start; }
  .cart-item img { width:60px; height:60px; margin-bottom:10px; }
}
@media(max-width:480px){
  .cart-item img { width:50px; height:50px; }
  .item-info h3 { font-size:16px; }
  .price { font-size:16px; }
  .qty-box button { padding:4px 8px; }
  .remove-btn { padding:6px 10px; }
  .total-box { font-size:20px; padding:15px; }
  #checkoutBtn { font-size:18px; padding:12px; }
}
</style>
</head>

<body>

<div id="langSelectContainer">
  <select id="langSelect">
    <option value="en">English</option>
    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
  </select>
</div>

<h1 id="cartTitle">Your Cart üõí</h1>
<div id="cartItems"></div>

<div class="total-box" id="totalBox">Total: 0 EGP</div>

<a id="checkoutBtn" href="checkout.html">Proceed to Checkout üí≥</a>

<a class="back-link" href="index.html" id="backLink">‚Üê Back to Home</a>

<script>
/* ================= CART + LANG ================= */

const CART_KEY = "nook_cart";     // ÿßŸÑÿ¨ÿØŸäÿØ
const OLD_CART_KEY = "cart";      // ÿßŸÑŸÇÿØŸäŸÖ
const MIGRATION_FLAG = "nook_cart_migrated_v1";
const FALLBACK_IMG = "https://i.postimg.cc/3RVR3GnB/ac037baf-0cb0-4349-9f9d-c1dbc61a6ddd.png";

const langData = {
  en: {
    cartTitle: "Your Cart üõí",
    emptyCart: "Your cart is empty.",
    total: "Total",
    remove: "Remove",
    back: "‚Üê Back to Home",
    checkout: "Proceed to Checkout üí≥"
  },
  ar: {
    cartTitle: "ÿ≥ŸÑÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ üõí",
    emptyCart: "ÿßŸÑÿ≥ŸÑÿ© ŸÅÿßÿ∂Ÿäÿ©",
    total: "ÿßŸÑŸÖÿ¨ŸÖŸàÿπ",
    remove: "ÿ•ÿ≤ÿßŸÑÿ©",
    back: "‚Üê ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©",
    checkout: "ŸÖÿ™ÿßÿ®ÿπÿ© ÿßŸÑÿØŸÅÿπ üí≥"
  }
};

function safeParse(v){
  try { return JSON.parse(v); } catch(e){ return null; }
}

function readCartRaw(key){
  const data = safeParse(localStorage.getItem(key));
  return Array.isArray(data) ? data : [];
}

function slugify(s){
  return String(s || "")
    .toLowerCase()
    .trim()
    .replace(/\s+/g, "_")
    .replace(/[^\w\-]+/g, "");
}

/* normalize any item shape into one standard shape */
function normalizeItem(it){
  const name = (it && it.name) ? String(it.name) : "Item";
  const price = Number(it && it.price) || 0;
  const qty = Math.max(1, Number(it && it.qty) || 1);
  const img = (it && it.img) ? String(it.img) : FALLBACK_IMG;

  // ‚úÖ stable id (NO index) to prevent duplicates
  const id =
    (it && it.id) ? String(it.id) :
    `p_${slugify(name)}_${price}_${slugify(img)}`;

  return {
    id,
    name,
    price,
    qty,
    img,
    category: it && it.category ? String(it.category) : "General",
    page: it && it.page ? String(it.page) : "",
    addedAt: it && it.addedAt ? String(it.addedAt) : new Date().toISOString()
  };
}

/* ‚úÖ merge + dedupe + sum qty (one-time use in migration) */
function mergeDedup(arrA, arrB){
  const map = new Map();

  [...arrA, ...arrB].forEach(raw => {
    const item = normalizeItem(raw);
    const key = item.id || `${item.name.toLowerCase()}__${item.price}`;

    if(!map.has(key)){
      map.set(key, {...item});
    }else{
      const existing = map.get(key);
      existing.qty = (Number(existing.qty) || 1) + (Number(item.qty) || 1);
      if((existing.img === FALLBACK_IMG) && item.img && item.img !== FALLBACK_IMG){
        existing.img = item.img;
      }
      map.set(key, existing);
    }
  });

  return Array.from(map.values()).filter(x => x && x.name);
}

/* ‚úÖ One-time migration: OLD cart -> NEW cart (then delete old to stop repetition) */
function migrateOldCartOnce(){
  const already = localStorage.getItem(MIGRATION_FLAG) === "1";
  if(already) return;

  const newCart = readCartRaw(CART_KEY);
  const oldCart = readCartRaw(OLD_CART_KEY);

  if(oldCart.length === 0){
    localStorage.setItem(MIGRATION_FLAG, "1");
    return;
  }

  // merge once
  const merged = mergeDedup(newCart, oldCart);

  localStorage.setItem(CART_KEY, JSON.stringify(merged));
  localStorage.setItem("cartItems", JSON.stringify(merged)); // for checkout

  // ‚úÖ delete old cart so it never duplicates again
  localStorage.removeItem(OLD_CART_KEY);

  localStorage.setItem(MIGRATION_FLAG, "1");
}

/* LANG */
const langSelect = document.getElementById("langSelect");
let currentLang = localStorage.getItem("siteLang") || "en";
langSelect.value = currentLang;

langSelect.addEventListener("change", ()=> {
  currentLang = langSelect.value;
  localStorage.setItem("siteLang", currentLang);
  renderCart();
});

/* ---------------------------
   CART STORAGE
---------------------------- */
function getCart(){
  const cart = safeParse(localStorage.getItem(CART_KEY));
  return Array.isArray(cart) ? cart : [];
}

function saveCart(cart){
  localStorage.setItem(CART_KEY, JSON.stringify(cart));
  localStorage.setItem("cartItems", JSON.stringify(cart));
}

/* ---------------------------
   UI RENDER
---------------------------- */
function renderCart() {
  const cart = getCart();
  let container = document.getElementById("cartItems");
  const data = langData[currentLang];

  document.getElementById("cartTitle").textContent = data.cartTitle;
  document.getElementById("backLink").textContent = data.back;
  document.getElementById("checkoutBtn").textContent = data.checkout;

  container.innerHTML = "";

  if (cart.length === 0) {
    container.innerHTML = `<h2 style="text-align:center;">${data.emptyCart}</h2>`;
    document.getElementById("totalBox").innerText = `${data.total}: 0 EGP`;
    document.getElementById("checkoutBtn").style.display = "none";
    return;
  }

  document.getElementById("checkoutBtn").style.display = "block";

  let total = 0;

  cart.forEach((item) => {
    const price = Number(item.price) || 0;
    const qty = Math.max(1, Number(item.qty) || 1);
    total += price * qty;

    const img = item.img || FALLBACK_IMG;
    const safeName = (item.name || "").replace(/</g, "&lt;").replace(/>/g, "&gt;");

    container.innerHTML += `
      <div class="cart-item" data-id="${item.id}">
        <img src="${img}" alt="${safeName}">
        <div class="item-info">
          <h3>${safeName}</h3>
          <div class="price">${price} EGP</div>
          <div class="qty-box">
            <button onclick="decreaseQty('${item.id}')">-</button>
            <span>${qty}</span>
            <button onclick="increaseQty('${item.id}')">+</button>
          </div>
        </div>
        <button class="remove-btn" onclick="removeItem('${item.id}')">${data.remove}</button>
      </div>
    `;
  });

  document.getElementById("totalBox").innerText = `${data.total}: ${total} EGP`;
}

/* ---------------------------
   ACTIONS (by id)
---------------------------- */
function increaseQty(id) {
  let cart = getCart();
  const item = cart.find(x => x.id === id);
  if(!item) return;
  item.qty = (Number(item.qty) || 1) + 1;
  saveCart(cart);
  renderCart();
}

function decreaseQty(id) {
  let cart = getCart();
  const item = cart.find(x => x.id === id);
  if(!item) return;
  const current = Number(item.qty) || 1;
  if(current > 1) item.qty = current - 1;
  saveCart(cart);
  renderCart();
}

function removeItem(id) {
  let cart = getCart();
  cart = cart.filter(x => x.id !== id);
  saveCart(cart);
  renderCart();
}

/* ‚úÖ run once */
migrateOldCartOnce();
renderCart();
</script>

</body>
</html>
